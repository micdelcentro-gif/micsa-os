<!DOCTYPE html>
<html lang="es">

<head>
    <!-- ============================================
         MICSA - DASHBOARD PRINCIPAL
         ============================================
         Panel de control central del Sistema Integrado de Gesti√≥n.
         
         Funcionalidades:
         - Navegaci√≥n r√°pida a todos los formularios
         - Estad√≠sticas del sistema
         - Accesos directos a reportes guardados
         - Vista general del progreso de implementaci√≥n
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MICSA - Sistema Integrado de Gesti√≥n Digital</title>

    <!-- Estilos principales compartidos -->
    <link rel="stylesheet" href="src/assets/styles.css">

    <!-- Google Fonts: Inter para tipograf√≠a moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Auth & Permissions -->
    <script src="src/js/auth.js"></script>
    <script src="src/js/permissions.js"></script>

    <!-- Estilos espec√≠ficos del dashboard -->
    <style>
        /* =====================================
           TARJETAS DE NAVEGACI√ìN PRINCIPAL
           ===================================== 
           Las tarjetas son los elementos principales de navegaci√≥n
           que permiten acceder a cada documento/formulario del sistema.
        */
        .nav-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        /* Estilos base de cada tarjeta de navegaci√≥n */
        .nav-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 30px;
            text-decoration: none;
            color: inherit;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        /* Efecto hover: eleva la tarjeta y cambia el borde */
        .nav-card:hover {
            transform: translateY(-8px);
            border-color: var(--accent-color);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
        }

        /* L√≠nea decorativa superior con gradiente */
        .nav-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        /* Icono grande de la tarjeta */
        .nav-card-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            display: block;
        }

        /* T√≠tulo de la tarjeta */
        .nav-card h3 {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Descripci√≥n de la tarjeta */
        .nav-card p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 16px;
        }

        /* Etiqueta de estado (Completado/Pendiente/En Progreso) */
        .status-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Estado: Completado (verde) */
        .status-complete {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }

        /* Estado: En Progreso (amarillo) */
        .status-progress {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }

        /* Estado: Nuevo/Pendiente (azul) */
        .status-new {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-color);
        }

        /* =====================================
           SECCI√ìN DE ESTAD√çSTICAS
           =====================================
           Muestra m√©tricas clave del sistema en formato de grid.
        */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }


        /* Cada caja de estad√≠stica */
        .stat-box {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            transition: var(--transition);
        }

        /* Efecto hover para las cajas de estad√≠sticas */
        .stat-box:hover {
            border-color: var(--accent-color);
        }

        /* N√∫mero grande de la estad√≠stica */
        .stat-box .number {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Etiqueta descriptiva de la estad√≠stica */
        .stat-box .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        /* =====================================
           SECCI√ìN DE ACCIONES R√ÅPIDAS
           =====================================
           Botones de acceso directo a acciones frecuentes.
        */
        .quick-actions {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 40px;
        }

        /* Cada bot√≥n de acci√≥n r√°pida */
        .quick-btn {
            padding: 14px 24px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Efecto hover para botones de acci√≥n */
        .quick-btn:hover {
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        /* =====================================
           SECCI√ìN DE REPORTES RECIENTES
           =====================================
           Lista de los √∫ltimos reportes guardados.
        */
        .recent-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 40px;
        }

        /* Encabezado de la secci√≥n de recientes */
        .recent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .recent-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        /* Lista de reportes recientes */
        .recent-list {
            list-style: none;
            padding: 0;
        }

        /* Cada item de reporte reciente */
        .recent-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--input-bg);
            border-radius: 10px;
            margin-bottom: 10px;
            transition: var(--transition);
        }

        .recent-item:hover {
            background: rgba(59, 130, 246, 0.1);
        }

        .recent-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .recent-item-icon {
            font-size: 1.5rem;
        }

        .recent-item-title {
            font-weight: 500;
            color: var(--text-primary);
        }

        .recent-item-date {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Bot√≥n de acci√≥n en cada item */
        .recent-item-action {
            padding: 8px 16px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .recent-item-action:hover {
            background: var(--primary-light);
        }

        /* =====================================
           SECCI√ìN DE PROGRESO DE IMPLEMENTACI√ìN
           =====================================
           Barra visual del avance en la implementaci√≥n ISO.
        */
        .progress-section {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 40px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-header h3 {
            color: var(--text-primary);
        }

        .progress-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success-color);
        }

        /* Barra de progreso visual */
        .progress-bar-container {
            background: var(--input-bg);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* Etapas de la implementaci√≥n */
        .progress-stages {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .stage {
            text-align: center;
            padding: 12px 8px;
            background: var(--input-bg);
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Etapa completada */
        .stage.completed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }

        /* Etapa actual */
        .stage.current {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
        }

        /* =====================================
           FOOTER DEL DASHBOARD
           =====================================
        */
        .dashboard-footer {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* =====================================
           RESPONSIVE: ADAPTACI√ìN A M√ìVILES
           =====================================
        */
        @media (max-width: 768px) {
            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }

            .progress-stages {
                grid-template-columns: repeat(4, 1fr);
            }

            .quick-actions {
                flex-direction: column;
            }
        }

        /* =====================================
           BARRA DE FILTROS (DASHBOARD)
           ===================================== */
        .filter-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.03);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .filter-input {
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--accent-color);
            background: rgba(59, 130, 246, 0.1);
        }

        .filter-input option {
            background-color: var(--card-bg);
            color: var(--text-primary);
        }
    </style>
</head>

<body>
    <!-- ============================================
         CONTENEDOR PRINCIPAL DEL DASHBOARD
         ============================================ -->
    <div class="container">

        <!-- ============================================
             ENCABEZADO DEL DASHBOARD
             ============================================ -->
        <header class="header">
            <div class="logo-section">
                <div class="logo">
                    <span class="logo-icon">üèóÔ∏è</span>
                    <span class="logo-text">MICSA</span>
                </div>
                <p class="logo-subtitle">Soluciones Industriales</p>
            </div>
            <div class="header-info">
                <h1>SISTEMA INTEGRADO DE GESTI√ìN</h1>
                <p>Panel de Control Digital</p>
                <div class="doc-info">
                    <span id="currentDate">Cargando fecha...</span>
                    <span id="currentTime">Cargando hora...</span>
                </div>
            </div>
        </header>

        <!-- ============================================
             REAL-TIME FINANCE & COMPLIANCE MONITOR (CEO VIEW)
             ============================================ -->
        <section class="stats-section">
            <div class="stat-box" style="border-left: 5px solid #10b981;">
                <div class="number" id="pnlKpi">$0.00</div>
                <div class="label">Utilidad Neta (Mes)</div>
            </div>
            <div class="stat-box" style="border-left: 5px solid #3b82f6;">
                <div class="number" id="complianceKpi">0%</div>
                <div class="label">Cumplimiento REPSE</div>
            </div>
            <div class="stat-box" style="border-left: 5px solid #f59e0b;">
                <div class="number" id="activeProjectsKpi">0</div>
                <div class="label">Proyectos Activos</div>
            </div>
            <div class="stat-box" style="border-left: 5px solid #ef4444;">
                <div class="number" id="stampingPendingKpi">0</div>
                <div class="label">Timbrados Pendientes</div>
            </div>
        </section>

        <!-- ============================================
             TARJETAS DE NAVEGACI√ìN PRINCIPAL
             ============================================
             Acceso a cada m√≥dulo del sistema
        -->
        <section>
            <h3 style="margin-bottom: 16px; color: var(--text-primary);">üìã M√≥dulos del Sistema</h3>
            <div class="quick-actions">
                <a href="src/pages/matriz-iso.html" class="quick-btn">üìä Matriz de Documentaci√≥n ISO</a>
                <a href="src/pages/guia-iso.html" class="quick-btn">üìò Gu√≠a de Implementaci√≥n ISO</a>
                <a href="src/pages/etiquetado.html" class="quick-btn">üè∑Ô∏è Sistema de Etiquetado</a>
                <a href="src/pages/reporte-diario.html?mode=new" class="quick-btn">‚ûï Crear Nuevo Reporte</a>
                <a href="src/pages/packing-list.html" class="quick-btn">üì¶ Packing List / Lista de Empaque</a>
                <a href="src/pages/cotizador.html" class="quick-btn"
                    style="border-color: var(--accent-color); background: rgba(59, 130, 246, 0.05);">‚ö° Cotizador
                    R√°pido</a>
                <a href="src/pages/users.html" class="quick-btn" data-permission="manage_users">üë• Gesti√≥n de
                    Usuarios</a>
                <a href="src/pages/projects.html" class="quick-btn" data-permission="manage_users">üèóÔ∏è Gesti√≥n de
                    Proyectos</a>
                <a href="src/pages/employees.html" class="quick-btn" data-permission="manage_users">üë∑ Gesti√≥n de
                    Empleados</a>
                <a href="src/pages/nomina.html" class="quick-btn" data-permission="manage_users">üí∞ N√≥mina RH</a>
                <a href="src/pages/contador-hub.html" class="quick-btn" data-permission="manage_users"
                    style="border-color: #8b5cf6; background: rgba(139, 92, 246, 0.05);">üíº Herramientas Contador</a>
                <a href="src/pages/ventas.html" class="quick-btn" data-permission="manage_users"
                    style="border-color: #f59e0b; background: rgba(245, 158, 11, 0.05);">üí∞ Control de Ventas</a>
                <a href="src/pages/repse.html" class="quick-btn" data-permission="manage_users"
                    style="border-color: #10b981; background: rgba(16, 185, 129, 0.05);">‚öñÔ∏è Cumplimiento REPSE</a>
            </div>
        </section>



        <!-- ============================================
             PROGRESO DE IMPLEMENTACI√ìN ISO
             ============================================
             Visualizaci√≥n del avance en las 7 fases
        -->
        <section class="progress-section">
            <div class="progress-header">
                <h3>üìà Progreso de Implementaci√≥n ISO 9001:2015</h3>
                <span class="progress-percentage" id="progressPercentage">25%</span>
            </div>

            <!-- Barra de progreso visual -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressFill" style="width: 25%;"></div>
            </div>

            <!-- Etapas del roadmap -->
            <div class="progress-stages">
                <div class="stage completed">
                    <strong>Fase 1</strong><br>Diagn√≥stico
                </div>
                <div class="stage current">
                    <strong>Fase 2</strong><br>Documentaci√≥n
                </div>
                <div class="stage">
                    <strong>Fase 3</strong><br>Implementaci√≥n
                </div>
                <div class="stage">
                    <strong>Fase 4</strong><br>Registros
                </div>
                <div class="stage">
                    <strong>Fase 5</strong><br>Auditor√≠a Int.
                </div>
                <div class="stage">
                    <strong>Fase 6</strong><br>Rev. Direcci√≥n
                </div>
                <div class="stage">
                    <strong>Fase 7</strong><br>Certificaci√≥n
                </div>
            </div>
        </section>

        <!-- ============================================
             REPORTES RECIENTES
             ============================================
             Lista de los √∫ltimos reportes guardados en localStorage
        -->
        <section class="recent-section">
            <div class="recent-header">
                <h3>üìÇ Borradores Guardados</h3>
                <a href="src/pages/reporte-diario.html"
                    style="color: var(--accent-color); text-decoration: none; font-size: 0.9rem;">Ver todos ‚Üí</a>
            </div>

            <!-- Barra de Filtros -->
            <div class="filter-bar">
                <div class="filter-group">
                    <label>No. Reporte</label>
                    <input type="text" id="filterNo" class="filter-input" placeholder="Ej: 0001"
                        oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Cliente</label>
                    <input type="text" id="filterClient" class="filter-input" placeholder="Ej: Ironcast"
                        oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Nombre Proyecto</label>
                    <input type="text" id="filterProject" class="filter-input" placeholder="Ej: Fabricaci√≥n..."
                        oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Ubicaci√≥n</label>
                    <input type="text" id="filterLocation" class="filter-input" placeholder="Ej: Planta 1"
                        oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Especificaci√≥n</label>
                    <input type="text" id="filterSpec" class="filter-input" placeholder="Ej: SPEC-99"
                        oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Fecha</label>
                    <input type="date" id="filterDate" class="filter-input" oninput="applyFilters()">
                </div>
                <div class="filter-group">
                    <label>Tipo de Documento</label>
                    <select id="filterType" class="filter-input" onchange="applyFilters()">
                        <option value="ALL">Ver Todos</option>
                        <option value="DAILY_REPORT">Reporte Diario</option>
                        <option value="PACKING_LIST">Packing List</option>
                    </select>
                </div>
            </div>

            <!-- Lista din√°mica de reportes (se llena con JavaScript) -->
            <ul class="recent-list" id="recentReportsList">
                <!-- Los items se agregan din√°micamente -->
            </ul>

            <!-- Mensaje si no hay reportes guardados -->
            <p id="noReportsMessage"
                style="text-align: center; color: var(--text-muted); padding: 20px; display: none;">
                No hay borradores guardados. <a href="src/pages/reporte-diario.html"
                    style="color: var(--accent-color);">Crear nuevo reporte</a>
            </p>
        </section>

        <!-- ============================================
             PIE DE P√ÅGINA DEL DASHBOARD
             ============================================ -->
        <footer class="dashboard-footer">
            <p><strong>MICSA - Sistema Integrado de Gesti√≥n de Calidad</strong></p>
            <p>Desarrollado conforme a ISO 9001:2015 | Versi√≥n 1.0</p>
            <p style="margin-top: 10px;">¬© 2026 MICSA Soluciones Industriales. Todos los derechos reservados.</p>
        </footer>
    </div>

    <!-- ============================================
         JAVASCRIPT: FUNCIONALIDAD DEL DASHBOARD
         ============================================ -->
    <script>
        /**
         * FUNCI√ìN: Actualizar fecha y hora en tiempo real
         * Muestra la fecha actual y actualiza la hora cada segundo
         */
        function updateDateTime() {
            const now = new Date();

            // Formatear fecha en espa√±ol
            const dateOptions = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            };
            const dateStr = now.toLocaleDateString('es-MX', dateOptions);

            // Formatear hora con AM/PM
            const timeStr = now.toLocaleTimeString('es-MX', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // Actualizar elementos del DOM
            document.getElementById('currentDate').textContent = dateStr;
            document.getElementById('currentTime').textContent = timeStr;
        }

        // Variable global para almacenar los reportes cargados
        let allReports = [];

        /**
         * FUNCI√ìN: Cargar reportes guardados desde el servidor
         */
        async function loadSavedReports() {
            const countElement = document.getElementById('savedReportsCount');
            const isoProgressElement = document.getElementById('isoProgress');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressFill = document.getElementById('progressFill');

            try {
                // 1. Cargar Reportes
                const response = await fetch('/api/reports');
                allReports = await response.json();

                // Aplicar filtros (inicialmente mostrar√° todos)
                applyFilters();

                if (countElement) {
                    countElement.textContent = allReports.length;
                }

                // 2. Cargar Progreso ISO
                const isoResponse = await fetch('/api/iso-progress');
                const isoData = await isoResponse.json();

                if (isoData) {
                    const percentage = isoData.percentage || 0;
                    // Ya no usamos isoProgressElement que quitamos del HTML, solo lo procesamos si existiera
                }

                // 3. Cargar KPIs Reales de Finanzas y REPSE
                await fetchDashboardKpis();

            } catch (error) {
                console.error('Error al cargar datos del servidor:', error);
            }
        }

        async function fetchDashboardKpis() {
            try {
                // P&L
                const now = new Date();
                const start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
                const end = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];

                const pnlRes = await fetch(`/api/accounting/reports/pnl?start=${start}&end=${end}`);
                const pnlData = await pnlRes.json();
                let net = 0;
                pnlData.forEach(i => {
                    if (i.type === 'INGRESO') net += (i.balance || 0);
                    else net -= Math.abs(i.balance || 0);
                });
                document.getElementById('pnlKpi').textContent = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(net);
                document.getElementById('pnlKpi').style.color = net >= 0 ? '#10b981' : '#ef4444';

                // Compliance
                const repseRes = await fetch('/api/repse/estatus-general');
                const repseData = await repseRes.json();
                document.getElementById('complianceKpi').textContent = repseData.status === 'VERDE' ? '100%' : '25%';
                document.getElementById('complianceKpi').style.color = repseData.status === 'VERDE' ? '#10b981' : '#f59e0b';

            } catch (err) {
                console.error('Error KPIs:', err);
            }
        }

        /**
         * FUNCI√ìN: Aplicar filtros a la lista de reportes
         */
        function applyFilters() {
            const fNo = document.getElementById('filterNo').value.toLowerCase();
            const fClient = document.getElementById('filterClient').value.toLowerCase();
            const fProject = document.getElementById('filterProject').value.toLowerCase();
            const fLocation = document.getElementById('filterLocation').value.toLowerCase();
            const fSpec = document.getElementById('filterSpec').value.toLowerCase();
            const fDate = document.getElementById('filterDate').value;
            const fType = document.getElementById('filterType').value;

            const recentList = document.getElementById('recentReportsList');
            const noReportsMsg = document.getElementById('noReportsMessage');

            recentList.innerHTML = '';

            const filtered = allReports.filter(report => {
                const data = report.data || {};
                const docType = report.document_type || 'DAILY_REPORT';
                const repoNo = (data.reporteNo || report.report_no || '').toString().toLowerCase();
                const client = (data.nombreCliente || data.cliente || '').toLowerCase();
                const project = (data.nombreProyecto || data.proyecto || '').toLowerCase();
                const location = (data.ubicacionPlanta || data.ubicacion || '').toLowerCase();
                const spec = (data.especificacionNo || data.especNo || '').toLowerCase();
                const date = data.fechaReporte || data.fecha || '';

                return repoNo.includes(fNo) &&
                    client.includes(fClient) &&
                    project.includes(fProject) &&
                    location.includes(fLocation) &&
                    spec.includes(fSpec) &&
                    (fDate === '' || date === fDate) &&
                    (fType === 'ALL' || docType === fType);
            });

            filtered.forEach(report => {
                const internalId = report.internal_id;
                const docType = report.document_type || 'DAILY_REPORT';
                const reportData = report.data || {};
                const displayNo = reportData.reporteNo || report.report_no || 'N/A';
                const especNo = reportData.especificacionNo || reportData.especNo || '';

                const isPacking = docType === 'PACKING_LIST';
                const icon = isPacking ? 'üì¶' : 'üìã';
                const titlePrefix = isPacking ? 'Packing List' : 'Reporte Diario de Obra';
                const editUrl = isPacking ? 'src/pages/packing-list.html' : 'src/pages/reporte-diario.html';

                const listItem = document.createElement('li');
                listItem.className = 'recent-item';
                listItem.innerHTML = `
                    <div class="recent-item-info">
                        <span class="recent-item-icon">${icon}</span>
                        <div>
                            <div class="recent-item-title">${titlePrefix} #${displayNo} ${especNo ? `<small style="color: var(--accent-color); margin-left:8px;">[Espec. ${especNo}]</small>` : ''}</div>
                            <div class="recent-item-date">Fecha: ${reportData.fechaReporte || reportData.fecha || 'Pendiente'} | Cliente: ${reportData.nombreCliente || reportData.cliente || 'N/A'} | Proyecto: ${reportData.nombreProyecto || reportData.proyecto || 'N/A'}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="recent-item-action" onclick="continuarReporte('${internalId}', '${editUrl}')">Continuar</button>
                        <button class="recent-item-action" style="background: #dc2626;" onclick="eliminarBorrador('${internalId}')">üóëÔ∏è</button>
                    </div>
                `;
                recentList.appendChild(listItem);
            });

            noReportsMsg.style.display = filtered.length === 0 ? 'block' : 'none';
            if (filtered.length === 0 && allReports.length > 0) {
                noReportsMsg.textContent = 'üîç No se encontraron reportes con esos criterios';
            } else if (allReports.length === 0) {
                noReportsMsg.innerHTML = 'No hay borradores guardados. <a href="reporte-diario.html" style="color: var(--accent-color);">Crear nuevo reporte</a>';
            }
        }

        function continuarReporte(internalId, editUrl = 'reporte-diario.html') {
            localStorage.setItem('MICSA_Ultimo_ID_Actual', internalId);
            window.location.href = editUrl;
        }

        async function eliminarBorrador(internalId) {
            if (confirm(`¬øEliminar este reporte permanentemente?`)) {
                try {
                    const response = await fetch(`/api/reports/${internalId}`, { method: 'DELETE' });
                    if (response.ok) {
                        loadSavedReports();
                    } else {
                        alert('Error al eliminar el reporte');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }

        /**
         * FUNCI√ìN: Exportar todos los datos a JSON
         * Genera un archivo descargable con todos los borradores guardados
         */
        function exportAllData() {
            const allData = {
                exportDate: new Date().toISOString(),
                reports: {},
                checklistProgress: JSON.parse(localStorage.getItem('MICSA_Checklist_Progress') || '[]'),
                ultimoReporteNo: localStorage.getItem('MICSA_Ultimo_Reporte_No') || '0'
            };

            // Recolectar todos los borradores
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('MICSA_Reporte_Borrador')) {
                    try {
                        allData.reports[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        console.error('Error al exportar:', key);
                    }
                }
            }

            // Crear archivo JSON para descarga
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MICSA_Respaldo_Total_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            alert('‚úÖ Respaldo total generado correctamente');
        }

        /**
         * FUNCI√ìN: Limpiar todos los borradores guardados
         * Pide confirmaci√≥n antes de eliminar los datos
         */
        function clearAllData() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar TODOS los borradores guardados?\n\nEsta acci√≥n borrar√° todos tus reportes y progreso ISO.')) {
                // Eliminar borradores individuales
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('MICSA_Reporte_Borrador')) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach(key => localStorage.removeItem(key));

                // Eliminar otros datos
                localStorage.removeItem('MICSA_Checklist_Progress');
                localStorage.removeItem('MICSA_Ultimo_Reporte_No');
                localStorage.removeItem('MICSA_Ultimo_Reporte_No_Actual');

                location.reload();
            }
        }

        /**
         * INICIALIZACI√ìN DEL DASHBOARD
         * Se ejecuta cuando el DOM est√° completamente cargado
         */
        document.addEventListener('DOMContentLoaded', function () {
            // Mostrar fecha y hora actual
            updateDateTime();

            // Actualizar la hora cada segundo
            setInterval(updateDateTime, 1000);

            // Cargar reportes guardados
            loadSavedReports();

            // Log de inicio
            console.log('üèóÔ∏è MICSA Dashboard cargado correctamente');
            console.log('üìä Sistema Integrado de Gesti√≥n - Panel de Control');
        });
    </script>
    <!-- Footer Version -->
    <div
        style="text-align: center; margin-bottom: 20px; color: #64748b; font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; width: 100%; max-width: 1200px; margin-left: auto; margin-right: auto;">
        MICSA Digital Suite v1.5.0 | Edici√≥n Profesional
    </div>
</body>

</html>